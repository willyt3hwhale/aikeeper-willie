#!/bin/bash
# willie - external orchestration loop for Claude Code

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
WILLIE_DIR="$SCRIPT_DIR/.willie"
VENV_DIR="$WILLIE_DIR/.venv"
REQUIREMENTS="prompt_toolkit"

# Create .willie directory if it doesn't exist
if [ ! -d "$WILLIE_DIR" ]; then
    echo "Error: .willie directory not found. Are you in a Willie project?"
    exit 1
fi

# Create venv if it doesn't exist
if [ ! -d "$VENV_DIR" ]; then
    echo "Setting up virtual environment..."
    python3 -m venv "$VENV_DIR"
    "$VENV_DIR/bin/pip" install --quiet --upgrade pip
    "$VENV_DIR/bin/pip" install --quiet $REQUIREMENTS
    echo "Setup complete."
fi

# Check if dependencies need to be installed
if ! "$VENV_DIR/bin/python" -c "import prompt_toolkit" 2>/dev/null; then
    "$VENV_DIR/bin/pip" install --quiet $REQUIREMENTS
fi

# Handle subcommands
case "${1:-}" in
    init)
        # Initialize project - interactive session to create idea.md
        claude "Read $WILLIE_DIR/working.md and help me initialize $WILLIE_DIR/idea.md with my project idea. Ask me questions until you're 99% sure about what I want to build. Cover: goals, constraints, tech stack, and success criteria."
        ;;
    *)
        # Run the main loop
        exec "$VENV_DIR/bin/python" "$WILLIE_DIR/willie.py" "$@"
        ;;
esac
